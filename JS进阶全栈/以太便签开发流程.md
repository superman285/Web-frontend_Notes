### æµç¨‹

---



ç¡®å®šå¥½é¡¹ç›®ä½¿ç”¨çš„æ¡†æ¶å’ŒæŠ€æœ¯ï¼Œæ­¤ä¾¿ç­¾é¡¹ç›® åç«¯é‡‡ç”¨nodejsçš„koa2æ¡†æ¶ï¼Œå‰ç«¯é‡‡ç”¨js+nunjucksæ¨¡æ¿å¼•æ“ï¼ŒåŒºå—é“¾éƒ¨åˆ†ä½¿ç”¨ä»¥å¤ªåŠsolidityæ™ºèƒ½åˆçº¦



##### ç›®å½•ç»“æ„

ä½¿ç”¨koa-generatorçš„koa2 projectNameå‘½ä»¤ç”Ÿæˆæ•´ä¸ªé¡¹ç›®ç»“æ„ï¼Œ



src/js/app

index.js å‰ç«¯å…¥å£æ–‡ä»¶



src/js/modç›®å½•ä¸‹

note.js ä¾¿ç­¾å¤„ç†é€»è¾‘

note-manager.js ä¾¿ç­¾ç®¡ç† ç®¡ç†note.js

toast.js æç¤ºç»„ä»¶

contractABI.js è¦ä½¿ç”¨çš„åˆçº¦åœ°å€ã€abiã€web3ã€ethersç­‰å·¥å…·



src/utils ç›®å½•

checkKey.js éªŒè¯ç§é’¥æˆ–åŠ©è®°è¯ ä¸è´¦æˆ· å¯¹åº”æ­£ç¡®æ€§

loginVerify.js ç™»å½•æ£€æŸ¥éªŒè¯ ä½¿ç”¨localStorage



routes/

åç«¯è·¯ç”±æ–‡ä»¶

api.js ä¾¿ç­¾çš„å„ç§é€»è¾‘çš„åç«¯è·¯ç”±å¤„ç†

index.js ä¸¤ä¸ªè·¯ç”± / å’Œ /checkLoginçš„å¤„ç†



public/

é™æ€èµ„æº ä¾‹å¦‚cssæ–‡ä»¶å’Œå›¾ç‰‡



views/

å‰ç«¯æ¨¡æ¿ index.njk é¦–é¡µ



contract/

å­˜æ”¾ä¾¿ç­¾åŠŸèƒ½åˆçº¦ NoteStorage.sol



æ³¨æ„ğŸ’¡ï¼š

ä»¥å¤ªåŠä¸­çš„ uint(addr)ç›¸å½“äºæŠŠåå…­è¿›åˆ¶è½¬ä¸ºåè¿›åˆ¶ï¼Œ

ç­‰åŒäºjsä¸­çš„Number(addr)æˆ– parseInt(addr)





##### JS/node å’ŒåŒºå—é“¾è¿æ¥éƒ¨åˆ†

å®‰è£…web3å’Œethersæ¨¡å—

npm i web3 ethers -S å‘½ä»¤



web3æ–¹å¼å®ä¾‹åŒ–åˆçº¦å¯¹è±¡

```javascript
const Web3 = require("web3");
var web3 = new Web3(new Web3.providers.HttpProvider("https://rinkeby.infura.io/v3/33a947db47094090b8331ea2f6f4bbd3"));
var noteContractObj = new web3.eth.Contract(abi,contractAddr);
```

httpprovideråœ°å€å¯çœ‹ ä¸‹æ–¹ infuraç”³è¯·å å¯è·å–

abiå’Œåˆçº¦åœ°å€ åœ¨remixä¸­å¯è·å–



ethersæ–¹å¼å®ä¾‹åŒ–åˆçº¦å¯¹è±¡

```javascript
const ethers = require("ethers");
var etherProvider = new ethers.providers.JsonRpcProvider("https://rinkeby.infura.io/v3/33a947db47094090b8331ea2f6f4bbd3");
var mywallet = new ethers.Wallet(privateKey,etherProvider);
var myetherContractObj = new ethers.Contract(contractAddr,abi,mywallet);
```

privateKeyç§é’¥ æ˜¯è‡ªå·±çš„è´¦æˆ·å¯¹åº”çš„ç§é’¥ å¯ä»¥è®©ç”¨æˆ·åœ¨å‰ç«¯è¾“å…¥



é¡¹ç›®ä¸­æ˜¯åç«¯è¿æ¥å¹¶è°ƒç”¨åŒºå—é“¾æ–¹æ³•ï¼Œä½¿ç”¨äº†ethersæ–¹å¼æ¥å®ä¾‹åŒ–åˆçº¦å¯¹è±¡(å®ä¾‹åŒ–æ—¶éœ€è¦ä½¿ç”¨åˆ°ç§é’¥ï¼Œåç»­ç­¾åäº¤æ˜“)ï¼Œæ›´åŠ ç®€ä¾¿ï¼›

å¦‚æœæ˜¯å‰ç«¯æ–¹å¼metamaskè¿æ¥è°ƒç”¨åŒºå—é“¾ï¼Œå¯ä»¥ç”¨web3æ–¹å¼(å®ä¾‹åŒ–åˆçº¦æ—¶ä¸æ¶‰åŠç§é’¥)ã€‚



api.jsä¸­

ethersæ„é€ åˆçº¦å®ä¾‹ etherContractObj è°ƒç”¨æ–¹æ³•

```javascript
let result = await etherContractObj.updateNote(noteid, note);
updateRes = {
    success: true,
    res: result
};
await result.wait();
```



##### æ™ºèƒ½åˆçº¦

æä¾›å­˜å‚¨ä¾¿ç­¾ï¼Œå¢åˆ æ”¹æŸ¥ä¾¿ç­¾åŠŸèƒ½

æ•°æ®ç»“æ„:

Noteä¾¿ç­¾ç»“æ„ä½“ åŒ…å«3ä¸ªå­—æ®µuid(ç”¨æˆ·id),noteid(ä¾¿ç­¾id),text(ä¾¿ç­¾å†…å®¹)

noteidåˆ°textçš„æ˜ å°„ notesContent

noteidåˆ°Noteç»“æ„ä½“çš„æ˜ å°„ notesMap

noteidåˆ°uidçš„æ˜ å°„ noteidTouid

uidåˆ°Noteæ•°ç»„çš„æ˜ å°„ userNotes

noteidåˆ°å®ƒå¯¹åº”çš„è‡ªå·±æ‰€åœ¨userNotesä½ç½®çš„ç´¢å¼• noteidToindex

(ç”±äºnoteidæ˜¯å…¨å±€çš„æ‰€æœ‰ä¾¿ç­¾å…±äº«çš„ï¼Œè€Œåˆ é™¤åªèƒ½åˆ è‡ªå·±çš„userNotesä¸­çš„ä¾¿ç­¾ï¼Œæ‰€ä»¥éœ€è¦è¿™ä¸ªå¯¹åº”å…³ç³»ä¾›åˆ é™¤ä¾¿ç­¾æ—¶ä½¿ç”¨)

æ‰€æœ‰ä¾¿ç­¾Noteçš„é›†åˆæ•°ç»„ notesArr

noteä¾¿ç­¾æ•°é‡ noteIdx



æ–¹æ³•:

è·å–æ‰€æœ‰ä¾¿ç­¾ getAllNotes() è·å–notesArr

è·å–è‡ªå·±çš„ä¾¿ç­¾ getMyNotes() è·å–userNotes[è‡ªå·±çš„uid]

è·å–ç‰¹å®šnoteidä¾¿ç­¾ getNote(uint noteid)

æ·»åŠ ä¾¿ç­¾ addNote(string text)

```javascript
uint myuid = uint(msg.sender);
uint noteid = ++noteIdx;
Note memory newNote = Note({
    uid:myuid,
    noteid:noteid,
    text:text
});
noteidTouid[noteid] = myuid;
notesContent[noteid] = text;
notesMap[noteid] = newNote;
notesArr.push(newNote);

uint userNotesLen = userNotes[myuid].push(newNote);
noteidToindex[myuid][noteid] = userNotesLen - 1;
```

éœ€è¦æŠŠç›¸åº”çš„å‡ ä¸ªæ•°æ®ç»“æ„ä¹ŸåŒæ—¶æ›´æ–°ï¼ŒåŒ…æ‹¬æ•°ç»„ã€æ˜ å°„ç­‰



æ›´æ–°ä¾¿ç­¾ updateNote(uint noteid,string text)

éœ€è¦requireåˆ¤æ–­æ˜¯ä¾¿ç­¾æ‰€æœ‰è€…æœ¬äººï¼Œä¿®æ”¹å¯¹åº”çš„å‡ ä¸ªæ•°æ®ç»“æ„

```javascript
require(uint(msg.sender) == noteidTouid[noteid],"you can only change the note belong to you!");
notesContent[noteid] = newtext;
notesMap[noteid].text = newtext;
notesArr[noteid-1].text = newtext;

uint myuid = uint(msg.sender);
uint correctIndex = noteidToindex[myuid][noteid];
userNotes[myuid][correctIndex].text = newtext;
```



deleteNote(uint noteid)

éœ€è¦requireåˆ¤æ–­ï¼Œå°†noteç›¸å…³æ•°æ®delete(ç½®ç©º) å¯¹åº”æ•°æ®ç»“æ„ä¸€èµ·æ›´æ–°

```javascript
require(uint(msg.sender) == noteidTouid[noteid],"you can only delete the note belong to you!");
//æ¶‰åŠåˆ°noteidçš„æ•°æ®éƒ½å¤„ç†ä¸‹
delete notesContent[noteid];
delete notesMap[noteid];
delete noteidTouid[noteid];
//åˆ é™¤ç»“æ„ä½“ï¼Œåˆ™æŠŠè¿™ä¸ªNoteå®ä¾‹ä¸­çš„ä¸‰ä¸ªå­—æ®µéƒ½ç½®ä¸º0å’Œç©ºä¸²
delete notesArr[noteid-1];
delete noteidTouid[noteid];

uint myuid = uint(msg.sender);
uint correctIndex = noteidToindex[myuid][noteid];
delete userNotes[myuid][correctIndex];
```



##### éƒ¨ç½²

###### äº‘æœåŠ¡å™¨éƒ¨ç½²

è´­ä¹°è…¾è®¯äº‘æœåŠ¡å™¨

https://cloud.tencent.com/developer/article/1004470



æ­å»ºå’Œé…ç½®å¥½nodejsç¯å¢ƒ

https://cloud.tencent.com/developer/labs/lab/10040



linuxç³»ç»Ÿå®‰è£…git

sudo apt-get install git

ç„¶åä½¿ç”¨å‘½ä»¤

git clone ä½ çš„githubé¡¹ç›®åœ°å€



å…‹éš†å¥½å å®šä½åˆ°é¡¹ç›®ç›®å½• è¿è¡Œé¡¹ç›® (å‘½ä»¤è¡Œnpm run start) åˆ™æœåŠ¡å™¨å¼€å¯äº†



![image-20190228180307151](/Users/superman285/Library/Application Support/typora-user-images/image-20190228180307151.png)



åœ¨è´­ä¹°çš„æœåŠ¡å™¨æ§åˆ¶å°é¡µé¢ æ‰¾åˆ°æœåŠ¡å™¨çš„å…¬ç½‘åœ°å€ 



å…¶ä»–äººè®¿é—®154.8.215.126:3000(å…·ä½“çœ‹é¡¹ç›®æŒ‡å®šçš„ç«¯å£) å³å¯çœ‹åˆ°ä½ çš„é¡¹ç›®äº†



###### æ™ºèƒ½åˆçº¦ç›¸å…³éƒ¨ç½²



ä½¿ç”¨remixå·¥å…· ç»“åˆ metamask (chromeæµè§ˆå™¨ä¸Š) è¿›è¡Œéƒ¨ç½²



![image-20190228181042853](/Users/superman285/Library/Application Support/typora-user-images/image-20190228181042853.png)



ç™»å½•ä¸Šmetamaskè´¦æˆ·å¹¶é€‰æ‹©è¿æ¥ rinkeby test network



ç”³è¯·rinkebyæµ‹è¯•ä»¥å¤ªå¸çš„æ–¹æ³•

https://my.oschina.net/u/3688108/blog/1572469



æˆ‘ä»¬ä½¿ç”¨infuraèŠ‚ç‚¹ï¼Œä¸è‡ªå·±æ­äº†ï¼Œinfuraæ›´ä¾¿æ·

https://infura.io/register ç”³è¯·æ³¨å†Œ è¾“å…¥ä¸€äº›èµ„æ–™ å¯ä»¥åˆ°é‚®ç®±æŸ¥çœ‹æ”¶åˆ°çš„key



ç„¶åå°±å¯ä»¥å¼€å§‹ä½¿ç”¨äº† ç™»å½•è‡ªå·±çš„è´¦æˆ· create new project

![image-20190228182041928](/Users/superman285/Library/Application Support/typora-user-images/image-20190228182041928.png)



ç„¶åENDPOINTé€‰æ‹©RINKEBYæµ‹è¯•ç½‘ ç„¶åå¤åˆ¶å‡ºè¿™ä¸ªåœ°å€ å°±æ˜¯ä¾›å‰ç«¯js åˆå§‹åŒ–webæ—¶ä½¿ç”¨çš„web3 providerçš„åœ°å€



åœ¨remixä¸Š ç„¶åremixçš„runé¡µç­¾ Environmenté€‰æ‹©Injected Web3

![image-20190228180612163](/Users/superman285/Library/Application Support/typora-user-images/image-20190228180612163.png)





![image-20190228180635067](/Users/superman285/Library/Application Support/typora-user-images/image-20190228180635067.png)



ç‚¹å‡»Deployå³å¯éƒ¨ç½²åˆçº¦ï¼Œå³ä¾§çº¢æ¡†ä¸­å›¾æ ‡å¯ä»¥å¤åˆ¶åˆçº¦åœ°å€



è¿™æ—¶å°±å°† åˆçº¦éƒ¨ç½²åœ¨äº†rinkebyæµ‹è¯•ç½‘ä¸Š





åˆ°æ­¤é¡¹ç›®çš„æœåŠ¡å™¨éƒ¨åˆ† åŒºå—é“¾éƒ¨åˆ†éƒ½éƒ¨ç½²å¥½äº† å°±å¯ä»¥è·‘èµ·æ¥äº†!