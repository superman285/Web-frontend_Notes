##### Koaæ¡†æ¶ ä¸€ä¸ªhttpæ¡†æ¶



Koaå…¶å®å°±æ˜¯å¯¹nodeåŸç”Ÿhttpå¯¹è±¡çš„äºŒæ¬¡åŒ…è£…ï¼Œæä¾›äº†æ›´å¥½çš„æ¥å£å’Œç»“æ„ï¼Œæ–¹ä¾¿ä½¿ç”¨å’Œç»´æŠ¤ã€‚

å…·ä½“API https://koa.bootcss.com/



Koaæœ¬èº«è¶…çº§ç®€å•ï¼Œä¹Ÿæ²¡è‡ªå¸¦è·¯ç”±ï¼Œå¯ä»¥å€ŸåŠ©åˆ«äººå®ç°çš„ç¬¬ä¸‰æ–¹ä¸­é—´ä»¶ï¼Œæ¥é…åˆä½¿ç”¨ã€‚

ä¾‹å¦‚è·¯ç”± : koa-router

ç¬¬ä¸‰æ–¹ä¸­é—´ä»¶å¤§å…¨ï¼šhttps://github.com/koajs/koa/wiki



å¸¸ç”¨ï¼š

koa-static-cache é™æ€èµ„æºä»£ç†

koa-router è·¯ç”±

nunjucks æ¨¡æ¿å¼•æ“

koa2-cors è§£å†³è·¨åŸŸé—®é¢˜



```javascript
const Koa = require('koa2');
//ç›¸å½“äºconst http = require('http');

//åˆ›å»ºä¸€ä¸ªç»è¿‡KoaåŒ…è£…çš„httpæœåŠ¡å™¨
const app = new Koa();
//ç›¸å½“äº const app = new http.Server();| æˆ– http.createServer();

//ç›‘å¬æŒ‡å®šç«¯å£
app.listen(80);
```





Koaå¸®æˆ‘ä»¬é‡æ–°åŒ…è£…äº†httpå¯¹è±¡(åŒ…æˆappå¯¹è±¡)ï¼Œå¹¶å¤„ç†äº†å¾ˆå¤šé€šç”¨æ•°æ®å’Œæ–¹æ³•ï¼Œå¹¶æŠŠè¿™äº›æ•°æ®å’Œæ–¹æ³•æŒ‚åˆ°äº†appçš„ä¸€ä¸ªå±æ€§ä¸‹é¢==app.context== contextä¸ºäº†æ–¹ä¾¿ä¸€èˆ¬å¯ç®€å†™ä¸ºctx



æ²¡æœ‰è¯·æ±‚çš„æ—¶å€™æ‰“å°(ç›´æ¥æ‰“å°åªèƒ½ç”¨dir)app.context æ˜¯ç©ºå¯¹è±¡ï¼Œè¿˜æ²¡æœ‰æ•°æ®è¿‡æ¥

==ä¸€èˆ¬ä¸ä¼šç›´æ¥è°ƒç”¨app.contextï¼Œå› ä¸ºè¯¥å¯¹è±¡æ²¡æœ‰ç»è¿‡å¤„ç†ï¼Œè€Œæ˜¯è¦é€šè¿‡ä¸­é—´ä»¶å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°å»æ‰ç”¨==

æœ‰è¯·æ±‚çš„æ—¶å€™ï¼Œä¸­é—´ä»¶å‡½æ•°å°±ä¼šæ‰§è¡Œï¼ŒåŒæ—¶Koaä¼šè§£ææ•°æ®å¹¶èµ‹å€¼ç»™app.contextï¼ŒæŠŠå®ƒä½œä¸ºå½“å‰æ‰§è¡Œçš„ä¸­é—´ä»¶çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥è¿›æ¥

è¿™æ ·ä½¿ç”¨ï¼š

app.use(ctx=>{console.log(ctx)})





contextä¸‹åŒ…å«çš„å¯¹è±¡ï¼Œè¯·æ±‚å“åº”ä¸¤å¤§å¯¹è±¡ å°±åŒhttpä¸€æ ·

- requestå¯¹è±¡
- responseå¯¹è±¡  |å“åº”(è¾“å‡º)|
- appå¯¹è±¡



contextå¯¹è±¡ä¸‹è¿˜æœ‰ä¸€äº›å±æ€§æ˜¯requestå’Œresponseçš„æ˜ å°„

e.g 

context.response.body === context.body

context.request.header === context.header

ä¸ºäº†å†™èµ·æ¥ç®€ä¾¿ï¼Œå¾ˆå¤šrequestå’Œresponseä¸‹çš„å¯¹è±¡éƒ½ç›´æ¥æŒ‚åœ¨äº†contextä¸‹ã€‚



==æ³¨æ„==

ctx.bodyæ˜¯ctx.response.body æ˜¯å“åº”çš„æ­£æ–‡ï¼Œæ˜¯æœåŠ¡å™¨å‘ç»™å®¢æˆ·ç«¯çš„ï¼



ctx.request.body å¹¶ä¸ä¸€æ · è¿™æ˜¯è¯·æ±‚çš„æ­£æ–‡ï¼Œæ˜¯å®¢æˆ·ç«¯å‘ç»™æœåŠ¡å™¨çš„ï¼



context.request.url



context.response.body = â€œ<h1>hello</h1>â€|â€œ{a:1,b:2}â€|â€œhello worldâ€

å¸®ä½ è‡ªåŠ¨è¾¨åˆ«ä½ æä¾›çš„æ•°æ®ï¼Œæ™ºèƒ½åœ°è®¾ç½®content-typeä¸ºhtml/json/plain (ç›¸å½“äºMIME)ï¼Œä¸ç”¨éº»çƒ¦ä½ è‡ªå·±å†åˆ¤æ–­



###### ä¸­é—´ä»¶çš„å†…æ¶µ

ä¸€ä¸ªhttpæœåŠ¡å™¨ä¸»è¦åšçš„äº‹æƒ…æµç¨‹æ˜¯å¦‚ä½•çš„ï¼Ÿ

- è§£æè¯·æ±‚ -> å¤„ç†æ•°æ® -> è¿”å›æ•°æ®



Koaæ¡†æ¶å¸®åŠ©æˆ‘ä»¬å¤„ç†ç¬¬ä¸€æ­¥çš„è¯·æ±‚è§£æå¹¶å°è£…åˆ°appå¯¹è±¡é‡Œé¢ä»¥ä¾›åç»­ä½¿ç”¨ä¸”åŒæ—¶å¸®æˆ‘ä»¬å¤„ç†æ•°æ®çš„è¿”å›ï¼Œæ¯”å¦‚æ ¹æ®å¤„ç†å¥½çš„æ•°æ®è¿”å›ä¸ä¸€æ ·çš„Content-Type



ä¸­é—´çš„æ­¥éª¤æ˜¯æ•°æ®å¤„ç†ï¼Œæ•°æ®çš„å¤„ç†å°±å’Œä¸šåŠ¡æ˜¯ç›¸å…³çš„(ä½ æœ‰ä»€ä¹ˆå…·ä½“éœ€æ±‚Koaè‚¯å®šä¸çŸ¥é“çš„)ï¼ŒKoaå°±æ— èƒ½ä¸ºåŠ›äº†



> ä¸­é—´ä»¶
>
> ==ä¸­é—´ä»¶å¯ä»¥ç†è§£ä¸ºå¯¹ç”¨æˆ·è¯·æ±‚è¿›è¡Œå¤„ç†(æˆ–è¿‡æ»¤ç­‰)çš„ä¸€ä¸ªä¸œè¥¿ï¼Œä¸ä¼šç›´æ¥å¯¹å‰ç«¯è¿›è¡Œå“åº”ï¼Œè€Œæ˜¯å°†å¤„ç†ç»“æœå¾€ä¸‹ä¼ é€’ï¼Œå°±æ˜¯ä¸­é—´å¤„ç†æ•°æ®çš„ä¸€ä¸ªéƒ¨ä»¶==
>
> éœ€è¦æˆ‘ä»¬å¤„ç†çš„æ­¥éª¤åœ¨ä¸­é—´(å¤„ç†æ•°æ®è¿™ä¸ªæ­¥éª¤)ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦é€šè¿‡æŸç§æ–¹å¼æŠŠæˆ‘ä»¬éœ€è¦çš„äº‹æƒ…æ³¨å†Œåˆ°Koaä¸­é—´ä»¶çš„åˆ—è¡¨ä¸­ï¼Œå½“Koaå¤„ç†å®Œæˆè§£æè¯·æ±‚åï¼Œå°±ä¼šè‡ªåŠ¨çš„æ‰§è¡Œæˆ‘ä»¬æ³¨å†Œçš„ä¸­é—´ä»¶ï¼Œæ‰§è¡Œå®Œä¸­é—´ä»¶åå°±ä¼šè‡ªåŠ¨è°ƒç”¨è¿”å›æ•°æ®çš„ä»£ç 



ä¸­é—´ä»¶æœ¬è´¨å°±æ˜¯ä¸€ä¸ªå‡½æ•°



æ³¨å†Œä¸­é—´ä»¶

app.use(function(){

}); 

//å¯ä»¥å¤„ç†ä»£ç†ã€è·¨åŸŸã€è´Ÿè½½ç­‰å„ç§å„æ ·çš„é—®é¢˜ ssræœåŠ¡å™¨ç«¯æ¸²æŸ“



ä¸­é—´ä»¶çš„nextæ–¹æ³•æ˜¯å¼‚æ­¥çš„ï¼Œéœ€è¦åŠ ä¸Šawait



Koaè§£å†³è·¨åŸŸç®€å•å†™æ³•

app.use( async (ctx,next) => {

ctx.set(â€˜Access-Control-Allow-Originâ€™,â€˜*â€™); await next();

})



##### Koaæ¡†æ¶åº”ç”¨



==è·¯å¾„å¼€å¤´çš„æ–œçº¿éå¸¸éå¸¸é‡è¦==



###### é™æ€èµ„æºä»£ç† koa-static-cache



> éœ€è¦è®¿é—®é™æ€èµ„æºæ—¶(ä¾‹å¦‚htmlå•Š å›¾ç‰‡å•Šä¹‹ç±»)ä½¿ç”¨é™æ€èµ„æºä»£ç† å¦åˆ™æ‰“å¼€æœåŠ¡å™¨å®ƒä¸çŸ¥é“è¯»å“ªä¸ªç›®å½• æƒ³æŠŠç›®å½•å½“æˆä¸€ä¸ªæœåŠ¡å™¨ è®¿é—®é‡Œå¤´çš„é™æ€èµ„æº å°±éœ€è¦åšè¿™ä¸€æ­¥
>
> å¦åˆ™è¯»ä¸åˆ°é™æ€èµ„æº
>
> åˆ‡è®°: è®¿é—®æ—¶è¦æ­£ç¡®è·¯å¾„/xxx.html åƒä¸‡åˆ«æ¼äº†(åŠ¨æ€è·¯ç”±ä¸éœ€è¦ï¼Œè¿™å„¿é™æ€çš„åƒä¸‡åˆ«å¼„é”™)
>
>
>
> dirè®¾ç½®é™æ€èµ„æºæ‰€åœ¨ç›®å½• è¦åŠ .
>
> prefixè®¾ç½®ä½ æƒ³è¦åŠ çš„å‰ç¼€ ä¸è®¾ç½®ä¹Ÿè¡Œçš„ ä¸åŠ .
>
> è®¿é—®åŠ¨æ€èµ„æºå¯ä½¿ç”¨è·¯ç”±koa-router é…åˆå‰ç«¯çš„getè¯·æ±‚çš„url
>
>









KoaStaticCache(dir\[,options]\[,files]) åŒ…è£…å‡½æ•°å†™æ³• è¿”å›ä¸€ä¸ªå‡½æ•°

dir:æŒ‡å®šè¦å¤„ç†çš„é™æ€æ–‡ä»¶(html)å­˜æ”¾ç›®å½•ï¼Œå½“ç”¨æˆ·è®¿é—®æŸä¸ªurlæ—¶



optionsä¸ºå¯¹è±¡ï¼Œå¯ä»¥ä¿®æ”¹

max-age æœ€é•¿ç¼“å­˜æ—¶é—´| æ˜¯å¦å‹ç¼©(gzip) | å‰ç¼€(prefix,è®¾ç½®urlå‰ç¼€) | dynamic(æ˜¯å¦åŠ¨æ€è¯»å–)

ä¾‹å¦‚prefix:/public åˆ™éœ€è¦è¯·æ±‚/public/index.htmlæ‰å¯ä»¥è®¿é—®

prefixçš„ä½œç”¨æ˜¯ å¯ä»¥åŒºåˆ†å¼€é™æ€èµ„æºå’Œéœ€è¦åŠ¨æ€å¤„ç†çš„èµ„æº åŠ ä¸Šå‰ç¼€æ‰å¯ä»¥æ­£å¸¸è®¿é—®

dynamic æ˜¯å¦åŠ¨æ€è¯»å–ï¼Œé»˜è®¤ä¸ºfalse

accept-encodingä¸ºæ”¯æŒçš„ç¼–ç (gzipæ›´å¸¸ç”¨)



è®¿é—®åŒä¸€ä¸ªurlæ—¶

- é™æ€èµ„æº: å¦‚æœèµ„æºå†…å®¹ä¸æ”¹å˜ï¼Œé‚£ä¹ˆè®¿é—®è¿™ä¸ªurlå¾—åˆ°çš„å†…å®¹ä¸ä¼šæœ‰ä»»ä½•å˜åŒ–

  ä¾‹å¦‚csså•Š å›¾ç‰‡å•Š éƒ¨åˆ†jsä»£ç (ç‰¹æ•ˆä¹‹ç±»)ç­‰

- åŠ¨æ€èµ„æº: åŒä¸€ä¸ªurlå¯èƒ½ä¼šæ ¹æ®ä¸åŒçš„å¤„ç†å¾—åˆ°==ä¸ä¸€æ ·==çš„å†…å®¹ 

  ä¸¾ä¸ªæ —å­ğŸŒ° ctx.body = â€œâ€+Math.random() æ¯æ¬¡è®¿é—®åŒä¸€ä¸ªurlå¾—åˆ°çš„å†…å®¹å¯èƒ½éƒ½ä¸ä¸€æ ·



é™æ€èµ„æºå¯ä»¥åˆ©ç”¨ç›´æ¥è¯»å–æ–‡ä»¶å¹¶è¿”å›çš„æ–¹å¼å¤„ç†ï¼Œä¾‹å¦‚åˆ©ç”¨koa-static-cache

åŠ¨æ€èµ„æºéœ€è¦å…·ä½“çš„å¤„ç†é€»è¾‘ï¼Œæ ¹æ®ä¸åŒçš„urlè¿”å›ä¸ä¸€æ ·çš„å†…å®¹

åŠ¨æ€èµ„æºçš„urlå¯èƒ½é‡ä¹Ÿå¾ˆå¤§ï¼Œä¸ºäº†æ›´å¥½åœ°å¤„ç†è¿™äº›åŠ¨æ€èµ„æºurlï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨==è·¯ç”±==ï¼Œä¾‹å¦‚koa-router



==Koaæ¡†æ¶å¸®æˆ‘ä»¬å¤„ç†äº†è¯·æ±‚ï¼Œå¤„ç†äº†è¾“å‡º==



å‘å®¢æˆ·ç«¯è¿”å›æ•°æ®æ˜¯é€šè¿‡ http=> end()æ–¹æ³•æ¥å®ç°çš„

æŠŠctx.bodyä½œä¸ºè¿”å›å€¼ï¼Œ ç›¸å½“äº.end(ctx.body)

æ‰€ä»¥ä¸éœ€è¦åœ¨ä¸­é—´ä»¶ä¸­æ‰‹åŠ¨è°ƒç”¨endæ–¹æ³•ï¼Œåªéœ€è¦ç»™ctx.bodyèµ‹å€¼



ç„¶è€Œä¸­é—´ä»¶å¾ˆå¤šéƒ½æ˜¯å¼‚æ­¥æ“ä½œï¼Œå¦‚æœä¸åšç‰¹æ®Šæ“ä½œ .endæ–¹æ³•ä¸ä¼šç­‰å¼‚æ­¥æ“ä½œå®Œæˆæ‰è°ƒç”¨ï¼Œæ‰€ä»¥é‚£æ—¶è°ƒç”¨ä¼šæ˜¯ not found (é‚£æ—¶ctx.bodyæ˜¯undefined)



å¦‚æœ await fn(); .end(ctx.body);  è¿™æ ·å°±ä¼šç­‰fnæ‰§è¡Œæœ‰ç»“æœå æ‰ä¼šè°ƒend



###### è·¯ç”± koa-router

è·¯ç”±ï¼šå³æ˜ å°„ï¼Œå†…å®¹åˆ†å‘ï¼Œä¸€ä¸ªurlä¸æŸä¸ªå‡½æ•°çš„ç»‘å®š å½¢æˆä¸€ç§å…³ç³»

ä¸ºæˆ‘ä»¬çš„url ç»‘å®šå¯¹åº”çš„ å¤„ç†å‡½æ•°



```javascript
router.use('/',ctx=>{})
/*
*useä¸ä¼šå¤„ç†è¯·æ±‚æ–¹æ³•,ä»»ä½•çš„è¯·æ±‚methodéƒ½ä¼šèµ°use,ä¸åŒºåˆ†get|post,ç±»ä¼¼ç»Ÿä¸€å…¥å£
*urléƒ¨åˆ†ä¹Ÿä¸æ˜¯ç›¸ç­‰ï¼Œè€Œæ˜¯åŒ…å«ï¼Œuseåˆ¤æ–­çš„æ˜¯æ˜¯å¦åŒ…å«'/',åªè¦å‰ç¼€ä¸º'/'éƒ½ä¼šèµ°use
*getä¸useçš„åŒºåˆ«æ˜¯getæ—¶è·¯å¾„å¿…é¡»ä¸ºç›¸ç­‰å…³ç³»ï¼Œè€Œuseæ—¶è·¯å¾„åŒ…å«å³å¯
*/

//useçš„ä½œç”¨,ä¾‹å¦‚å¯ä»¥åšä¸€ä¸ªç”¨æˆ·ç»Ÿä¸€éªŒè¯,è¦ä¹ˆç»™æ¯ä¸ªgetçš„/useråšä¸ªéªŒè¯,è¦ä¹ˆåœ¨useç»™/useråšéªŒè¯å³å¯ã€‚

router.get('/',ctx=>{
    ctx.body="é¦–é¡µ";
})
router.get('/user',ctx=>{
    ctx.body="ç”¨æˆ·";
})
/*æŠŠè®¾ç½®å¥½çš„è·¯ç”±å¯¹è±¡æŒ‚åˆ°æŒ‡å®šçš„appå¯¹è±¡ä¸Š,appæ¥æ”¶åˆ°è¯·æ±‚åä¼šæŠŠè¯·æ±‚è½¬å‘ç»™router.routes()ä¸­é—´ä»¶
* app -> router -> æ ¹æ®ä¸åŒurlæ‰§è¡Œä¸åŒçš„ç»‘å®šå‡½æ•°
*/
app.use(router.routes())
```



> ğŸ’¡æ³¨æ„
>
> å¤šä¸ªä¸­é—´ä»¶å‡½æ•°åªä¼šé»˜è®¤æ‰§è¡Œç¬¬ä¸€ä¸ªï¼Œåç»­çš„ä¸­é—´ä»¶å‡½æ•°éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨è°ƒç”¨
>
> ä¸­é—´ä»¶å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªnextæ–¹æ³•ï¼Œè°ƒç”¨è¯¥æ–¹æ³•å°±å¯ä»¥æ‰§è¡Œä¸‹ä¸€ä¸ªåŒ¹é…çš„ä¸­é—´ä»¶
>
> d
>
> router.use(â€˜/userâ€™,(ctx,next)=>{
>
> â€‹    //åˆ¤æ–­
>
> â€‹    next();
>
> })



redirectæ–¹æ³• é‡å®šå‘(ä¸è®¾ç½®é»˜è®¤ä¸º302) | é‡å®šå‘åˆ†ä¸º 301æ°¸ä¹…é‡å®šå‘ , 302ä¸´æ—¶é‡å®šå‘

router.redirect(â€˜/loginâ€™,â€˜/login1â€™,302); //ä¸´æ—¶è®¾ç½®loginé‡å®šå‘åˆ°login1ï¼Œå‚æ•°ä¹Ÿå¯ä»¥è®¾ç½®ä¸º301



prefixè®¾ç½®å‰ç¼€ï¼Œçœå»åé¢é‡å¤å†™çš„æ—¶å€™éº»çƒ¦

const router = new KoaRouter({

â€‹    prefix: â€œ/userâ€

});



==path-to-regexp==

/:id è¡¨ç¤º/åé¢é¢çš„å€¼æ˜¯ä¸å›ºå®šçš„ï¼Œæ‰€æœ‰ç¬¦åˆ



æ¸©ä¹ ä¸‹2å°æ—¶å¤„è§†é¢‘å†…å®¹ï¼Œæ¨¡æ¿å­—ç¬¦ä¸²ï¼Œå¯¹è±¡è§£æ„ï¼Œfindç”¨æ³•ç­‰çŸ¥è¯†ç‚¹ï¼Œ



æ¨¡æ¿å­—ç¬¦ä¸²æ”¯æŒè¡¨è¾¾å¼ï¼Œä¸æ”¯æŒè¯­å¥

å¯ä»¥è¿™ä¹ˆå†™${users.map(user=>\<li>\</li>).join(â€˜â€™)}



###### nunjucks æ¨¡æ¿å¼•æ“



æ¸²æŸ“å·¥ä½œæ˜¯åœ¨åç«¯è¿›è¡Œçš„



let str = tpl.renderString(â€˜<h1>Hello {{username}}</h1>â€™,{username:xxxx})







{{var}}ä»£è¡¨å˜é‡ ç±»ä¼¼es6ä¸­çš„${var}



ç®¡é“ç¬¦|  ç®¡é“ç¬¦å‰çš„å†…å®¹ä½œä¸ºå‚æ•°ä¼ ç»™ç®¡é“ç¬¦åçš„å‡½æ•° ä¾‹å¦‚{{var|upper}}





##### æ–‡ä»¶ä¸Šä¼ æ¨¡å— koa-multer

storageé…ç½®



å°è£…çš„fileå±æ€§ fieldname | originalname | encoding | mimetype