##### åŒæ­¥å¼‚æ­¥

scriptæ ‡ç­¾åŠ è½½æ–¹å¼ä¸ºåŒæ­¥é˜»å¡æ–¹å¼ï¼Œæ‰€ä»¥ä¸€èˆ¬æ”¾åœ¨bodyæœ€å

æœ€æ–°esç‰ˆæœ¬ scriptæ ‡ç­¾å¢åŠ äº†asyncå±æ€§ å¯è®¾ç½®ä¸ºtrue åˆ™ä¸ºå¼‚æ­¥åŠ è½½

createElementåˆ›å»ºscriptå¯¹è±¡åŠ è½½ ä¸ºå¼‚æ­¥éé˜»å¡æ¨¡å¼



##### å…ˆè®°ä½å†™æ³•

new Promise(function(resolve,reject){dosomething(å¼‚æ­¥ä»£ç )})

==ç­‰ä»·äº==

new Promise((resolve,reject)=>{dosomething(å¼‚æ­¥ä»£ç )})



Promiseä¸ºjså†…ç½®çš„æ„é€ å‡½æ•°ï¼Œæ„é€ çš„Promiseå¯¹è±¡æ˜¯==ä¸“é—¨ç”¨äºå¤„ç†å¼‚æ­¥ä»»åŠ¡çš„ç®¡ç†å·¥å…·==



> Promiseå¹¶ä¸æ˜¯å°†å¼‚æ­¥å˜ä¸ºåŒæ­¥
>
> è€Œæ˜¯æä¾›äº†ä¸€ç§å¼‚æ­¥ä»£ç çš„ç®¡ç†æ–¹å¼ï¼Œå°†åµŒå¥—å…³ç³»(å›è°ƒåœ°ç‹±)å˜ä¸ºå¹³è¡Œå…³ç³»





##### PromiseçŠ¶æ€

> **Promiseçš„çŠ¶æ€æ˜¯ä¸å¯é€†çš„ï¼Œä¸€æ—¦çŠ¶æ€å‘ç”Ÿæ”¹å˜å°±æ°¸è¿œæ— æ³•è¿˜åŸ(ä½ æ‰‹åŠ¨ä¹Ÿæ”¹ä¸äº†)**

Promiseå¦‚ä½•ç®¡ç†å¼‚æ­¥ä»£ç ï¼Ÿ

å®ƒä¸ºæ¯ä¸€ä¸ªä»»åŠ¡éƒ½ç»´æŠ¤äº†ä¸€ä¸ªå†…éƒ¨çŠ¶æ€ï¼Œæˆ‘ä»¬å¯æ ¹æ®å¼‚æ­¥ä»£ç çš„æ‰§è¡Œç»“æœå»åŠ¨æ€æ”¹å˜Promiseçš„å†…éƒ¨çŠ¶æ€ï¼Œä»è€Œå®ç°åç»­ä»£ç çš„è°ƒç”¨

(æ˜¯æˆ‘ä»¬æ‰‹åŠ¨æ”¹å˜çŠ¶æ€ï¼Œä¸æ˜¯Promiseè‡ªå·±ç»´æŠ¤çš„ï¼Œå¦‚æœæˆ‘ä»¬ä¸å»æ‰‹åŠ¨æ”¹ï¼Œ**æ°¸è¿œéƒ½æ˜¯åˆå§‹çŠ¶æ€pending**)

- pending - åˆå§‹çŠ¶æ€ æ—¢éæˆåŠŸ ä¹Ÿéå¤±è´¥ åœ¨ç­‰å¾…
- resolved - æ“ä½œæˆåŠŸ é€šè¿‡resolve(xx)æ–¹æ³• ä¹‹åè°ƒç”¨thenæ–¹æ³•
- rejected - æ“ä½œå¤±è´¥ é€šè¿‡reject(yy)æ–¹æ³• ä¹‹åè°ƒç”¨catchæ–¹æ³•

resolveå’Œrejectå‡½æ•°è°ƒç”¨ç±»ä¼¼äº‹ä»¶å¯¹è±¡eventï¼Œéœ€è¦ä¼ å…¥è¿›new Promiseçš„å‚æ•°ä¸­æ‰å¯è°ƒç”¨ï¼

Promiseçš„çŠ¶æ€è¢«ä¿®æ”¹å å°±ä¼šè°ƒç”¨åç»­çš„thenã€catchæ–¹æ³• 



Promiseä¸­çš„å¼‚æ­¥ä»»åŠ¡ä»€ä¹ˆæ—¶å€™ å¯ä»¥ç»§ç»­å‘ä¸‹æ‰§è¡Œ å…¨å‡­ä½ å©å’ çœ‹ä½ ä»€ä¹ˆæ—¶å€™æ”¹Promiseçš„çŠ¶æ€

(çœ‹ä½ ä»€ä¹ˆæ—¶å€™è°ƒresolveæˆ–rejectæ–¹æ³•)



ç‰¹æ®Šå†™æ³•ï¼šreturn Promise.resolve(xx) | return Promise.reject(yy)

è¿™ä¸ªå†™æ³•æ—¢æ”¹å˜äº†PromiseStatusä¹Ÿæ”¹å˜äº†PromiseValue



##### Promiseå¯¹è±¡çš„thenæ–¹æ³•

thenæ–¹æ³•å¯æ¥æ”¶==ä¸¤ä¸ªå‡½æ•°==ä½œä¸ºå‚æ•°ï¼Œç¬¬ä¸€ä¸ªè¡¨ç¤ºresolvedï¼Œç¬¬äºŒä¸ªè¡¨ç¤ºrejected

å¦‚æœåªæ¥æ”¶äº†ä¸€ä¸ªå‡½æ•° é‚£ä¹ˆå°±æ˜¯æˆåŠŸ

thenæ–¹æ³•çš„å‚æ•°å‡½æ•°åªèƒ½æ¥æ”¶ä¸€ä¸ªå€¼

let p1 = new Promise((resolve,reject)=>{dosomething;resolve();})

p1.then(()=>{},()=>{})

å¦‚æœp1æ˜¯resolvedçŠ¶æ€åˆ™èµ°thenæ–¹æ³•ä¸­çš„ç¬¬ä¸€ä¸ªå‡½æ•°ä½“ï¼Œ

å¦‚æœp1æ˜¯rejectedçŠ¶æ€åˆ™èµ°thenæ–¹æ³•ä¸­çš„ç¬¬äºŒä¸ªå‡½æ•°ä½“ã€‚

ğŸ’¡æ³¨:

å¦‚æœåœ¨è°ƒç”¨resolve(par1)æˆ–reject(par2)æ–¹æ³•æ—¶ä¼ å…¥äº†å‚æ•°å€¼parï¼Œparå¯ä»¥è¢«ä¼ é€’åˆ°thenæ–¹æ³•ä¸­ä½¿ç”¨å“¦ï¼Œparå°±èµ‹ç»™äº†Promiseå†…éƒ¨çš„PromiseValue

p1.then(par1=>{},par2=>{})par1ä¸ºresolveçŠ¶æ€çš„PromiseValue,par2ä¸ºrejectedçŠ¶æ€çš„PromiseValue



==åŒä¸€ä¸ªPromiseå¯¹è±¡==çš„thenæ–¹æ³•éƒ½æ˜¯åŒçº§(ç›¸å½“äºå¹¶å‘æˆ–å¹¶è¡Œ)çš„ï¼Œç±»ä¼¼addEventListeneräº‹ä»¶æ³¨å†Œæœºåˆ¶

p1.then(xx=>{yy1});p1.then(xx=>{yy2})



> **thenæ–¹æ³•ä¹Ÿæ˜¯æœ‰é»˜è®¤è¿”å›å€¼çš„**
>
> ---
>
> p1å¯¹è±¡çš„thenæ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„Promiseå¯¹è±¡p2(ä¸åŒäºp1)
>
>
>
> ***å¤§å‘:***
>
> ä¸€æ—¦ä½ è°ƒç”¨äº†thenæˆ–catchæ–¹æ³•è€Œä¸”é‡Œå¤´æœ‰ä¼ å‡½æ•°ä½œä¸ºå‚æ•°(å³ä½¿å‡½æ•°ä½“ä¸ºç©ºï¼)ï¼Œä½†ä½ æ²¡æœ‰æ‰‹åŠ¨return new Promiseå’Œåœ¨é‡Œå¤´æ›´æ”¹statuså’Œvalueçš„è¯
>
> é‚£thenæˆ–catch`ä¹‹å`ä¸€å®šä¼šç»™ä½ è¿”å›è¿™ä¹ˆä¸€ä¸ªPromise: <resolved>: undefined
>
> å› ä¸ºthenç¬¬ä¸€ä¸ªå‚æ•°ä»£è¡¨resolve,è€Œcatchå…¶å®ç›¸å½“äºthen(undefined,(xxx)=>{yyy})
>
> ä¸ä¿¡ä½ å»è¯•è¯• ä¾‹å¦‚p2 = p1.then(()=>{},x=>{console.log(x)})
>
> p3=p2.catch(y=>{console.log(y)})
>
> ==å°å‘==
>
> å¦‚æœä½ åœ¨å‡½æ•°ä½“ç»“å°¾å†™äº†return 2;è¿”å›å€¼å¹¶ä¸æ˜¯2,è€Œæ˜¯
>
> Promise {<resolved>: 2} æ²¡æƒ³åˆ°å§.
>
> æ‰€ä»¥ä¸‹ä¸€ä¸ªthenå¯ä»¥è·å–åˆ°2
>
> then(val=>{console.log(val);return 2;}).then(val2=>console.log(val2);)
>
> //ç¬¬äºŒä¸ªthenæ‰“å°val2 å°±æ˜¯æ‰“å°å‡º2
>
>
>
> æ‰€ä»¥å¯ä»¥åŠ¨æ‰‹é€ ä¸€ä¸ªnew Promiseä½œä¸ºè¿”å›å€¼ï¼Œåœ¨è¿™ä¸ªnew Promiseä¸­æ ¹æ®éœ€æ±‚æ‰‹åŠ¨è®¾å®šçŠ¶æ€
>
> åˆ‡è®°è¿™ä¸ªæ‰‹åŠ¨é€ çš„æ–°Promiseå¾—ä¼ å…¥å‚æ•°resolveæˆ–reject



thenæ–¹æ³•å¯ä»¥é“¾å¼è°ƒç”¨ï¼Œæœ€å¥½æ¯ä¸ªthenä¸­éƒ½åŠ¨æ‰‹æ„é€ new Promiseä½œä¸ºè¿”å›å€¼ï¼Œæ ¹æ®éœ€æ±‚æ¥æ”¹å˜çŠ¶æ€ï¼Œ

ä½†æ˜¯æœ€åä¸€ä¸ªthenä¸éœ€è¦æ‰‹åŠ¨æ„é€ äº†ï¼Œå› ä¸ºåç»­æ²¡æœ‰è¦æ‰§è¡Œçš„ä»£ç äº†



thenæ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•° å°±ç›¸å½“äºcatch

then(res=>{},rej=>{}) ç›¸å½“äº then(res=>{}).catch(rej=>{})



###### catch

catchç›¸å½“äºthençš„ä¸€ç§ç‰¹æ®Šæƒ…å†µçš„ä¸€ä¸ªè¯­æ³•ç³– ä¹Ÿæ˜¯å¯ä»¥é“¾å¼è°ƒç”¨æ»´

p1.then(()=>{},x=>{y}) => p1.then(undefined,x=>{y})

=> p1.catch(x=>{y}) éƒ½æ˜¯ç­‰ä»·çš„

æƒ³é“¾å¼è°ƒç”¨å¤šä¸ªcatch ä¸­é—´ä¸€å®šè¦æ‰‹åŠ¨è¿”å›new Promiseä¸”reject(val)æ”¹å˜çŠ¶æ€å’Œå€¼

p1.catch(x=>{}).catch(x=>{}).catch(x=>{});



###### finally

å¦‚æœä½ æƒ³åœ¨ promise æ‰§è¡Œå®Œæ¯•åæ— è®ºå…¶ç»“æœæ€æ ·éƒ½åšä¸€äº›å¤„ç†æˆ–æ¸…ç†æ—¶ï¼Œå¯ä»¥åœ¨é“¾å¼è°ƒç”¨æœ«å°¾ä½¿ç”¨finally

p1.then().then().finally(()=>{})



##### Promiseå¤šä»»åŠ¡å¤„ç†

- Promise.all

  å½“å‚æ•°ä¸­æ‰€æœ‰Promiseéƒ½åˆ°è¾¾äº†æˆåŠŸçŠ¶æ€(resolved)æ‰å¯ä»¥æ‰§è¡Œåç»­çš„then

  ä¸€ä¸ªä»»åŠ¡ä¾èµ–å¤šä¸ªä»»åŠ¡çš„å¤„ç†ç»“æœæ—¶å¯ç”¨

  let p1 = new Promise(xx;resolve(p1v)); let p2 = new Promise(yy;resolve(p2v));

  Promise.all([p1,p2]).then(val=>{//æ‹¿åˆ°p1å’Œp2ç»“æœåæ‰æ‰§è¡Œçš„ä»£ç })

  thenä¸­çš„valå€¼ä¸ºæ•°ç»„ï¼Œæ•°ç»„å…ƒç´ ä¸ºå‰é¢å¼‚æ­¥ä»»åŠ¡çš„å€¼(å³p1å’Œp2 ä¼ ç»™resolveå‡½æ•°çš„å€¼)PromiseValue

  val->[p1v,p2v]

  æ‰€æœ‰promiseæˆåŠŸæ‰ä¼šè¿”å›æˆåŠŸï¼Œä¸€ä¸ªpromiseå¤±è´¥å°±è¿”å›å¤±è´¥

  è¿”å›æˆåŠŸå€¼æ•°ç»„ | è¿”å›æœ€å¿«å¤±è´¥çš„promise

- Promise.race

  å½“å‚æ•°ä¸­çš„Promiseä½†å‡¡æœ‰ä¸€ä¸ªåˆ°è¾¾äº†æˆåŠŸçŠ¶æ€(resolved)å°±å¯ä»¥æ‰§è¡Œåç»­çš„then

  ä¸€ä¸ªä»»åŠ¡ä¾èµ–äºå¤šä¸ªä»»åŠ¡ä¸­ä»»æ„ä¸€ä¸ªå¤„ç†ç»“æœæ—¶å¯ç”¨

  Promise.race([p1,p2]).then(v=>{})

  thenä¸­çš„vä»£è¡¨çš„æ˜¯æœ€å…ˆå®Œæˆçš„Promiseå¯¹è±¡çš„PromiseValue(p1å’Œp2ä¸­å…ˆå®Œæˆçš„é‚£ä¸ªä¼ ç»™resolveå‡½æ•°çš„å€¼)

  ä¸€ä¸ªpromiseæˆåŠŸå°±è¿”å›æˆåŠŸï¼Œä¸€ä¸ªpromiseå¤±è´¥å°±è¿”å›å¤±è´¥

  è¿”å›æœ€å¿«æˆåŠŸçš„promise | è¿”å›æœ€å¿«å¤±è´¥çš„promise



---



thenä¸­å¤„ç†è¿”å›å€¼æ–¹æ¡ˆé€‰æ‹©(éœ€ä¸éœ€è¦æ‰‹åŠ¨returnæ–°Promiseå‘¢?)ï¼š

1. thenä¸­æ²¡æœ‰å¼‚æ­¥ä»£ç |é€»è¾‘å¤„ç†æˆ–ä¸éœ€è¦å‘ä¸‹ä¼ å€¼äº†ï¼Œæˆ‘ä»¬åªéœ€è¦ç”¨thené»˜è®¤è¿”å›çš„promiseå³å¯

   é»˜è®¤è¿”å›çš„promiseçš„çŠ¶æ€ç»§æ‰¿è‡ªä¸Šä¸ªpromiseçš„çŠ¶æ€(new Promiseè¿‡æ¥çš„æˆ–thenè¿‡æ¥çš„)

2. å¦‚æœthenä¸­æœ‰å¼‚æ­¥ä»£ç  æˆ–è€…éœ€è¦å‘ä¸‹ä¼ å€¼ï¼Œæˆ‘ä»¬å°±éœ€è¦æ‰‹åŠ¨è¿”å›new Promise

- å¦‚æœä»…ä»…éœ€è¦ä¼ ä¸ªå€¼ ç®€æ´åœ°ç”¨return Promise.resolve(val)æˆ–Promise.reject(val) å³å¯

- å¦‚æœé™¤äº†ä¼ å€¼å¯èƒ½è¿˜æœ‰æ›´å¤æ‚çš„å¼‚æ­¥ä»»åŠ¡å’Œé€»è¾‘è¦å¤„ç†ï¼Œå°±ä½¿ç”¨

  return new Promise(resolve=>{

  //dosomething;

  resolve(val)

  })



> å‡ æ®µä»£ç è¯»æ‡‚promiseç‰¹æ€§ https://www.jb51.net/article/119630.htm





###### ğŸ’¡è¡¥å……çŸ¥è¯†ç‚¹:jså†…ç½®å±æ€§[[prop]] åŒæ–¹æ‹¬å·

[[PromiseStatus]]å’Œ[[PromiseValue]]

å‡ä¸ºjså†…ç½®å±æ€§ï¼Œè¿™ç§åŒæ–¹æ‹¬å·å±æ€§æ— æ³•ç›´æ¥è¿›è¡Œè¯»æˆ–å†™æ“ä½œï¼Œåªèƒ½é€šè¿‡ç‰¹å®šæ–¹æ³•æ¥è¿›è¡Œè¯»å†™æ“ä½œã€‚

ç‰¹å®šæ–¹æ³•æ¥äº†:

Promise.resolve(1) å°±ç›¸å½“äºæŠŠpromiseçš„statusè®¾ç½®ä¸ºresolved,PromiseValueè®¾ä¸º1

æƒ³è¯»å–PromiseValueåªèƒ½ Promise.resolve(â€˜helloâ€™).then(res=>{console.log(res)})

thenä¸­æ‰å¯ä»¥æ‰“å°å‡ºâ€˜helloâ€™

æˆ–è€…è¿™ç§å†™æ³•:

```javascript
(async ()=>{
    let res = await Promise.resolve('hello');
    console.log(res);
})()
//æ³¨æ„console.log(res)è¦ç´§è·Ÿåœ¨awaitåæ‰æœ‰æ•ˆ
```



Promise.resolve() åˆ™ Promiseä¸º resolved:undefined



==æ³¨æ„==

var er = Promise.reject(â€˜err2â€™) ä¼šæ”¹å˜PromiseStatusä¸ºrejectedå’ŒPromiseValueä¸ºâ€˜err2â€™

ä½†æ˜¯ä¼šæŠ¥é”™ Uncaught (in promise) err2

è¿˜æ˜¯å¾—å¤„ç†ä¸‹é”™è¯¯



##### asyncå’Œawait å¾ˆç”œçš„è¯­æ³•ç³–

è‹¥å°†å‡½æ•°å£°æ˜ä¸ºasyncï¼Œä¸€èˆ¬æ²¡å†™returnçš„å‡½æ•°åŸæœ¬é»˜è®¤è¿”å›undefinedï¼ŒåŠ äº†asyncå£°æ˜åé»˜è®¤è¿”å›å€¼ä¸ºPromiseå¯¹è±¡: Promise {<resolved>: undefined}

è‹¥åœ¨asyncå‡½æ•°æœ«å°¾return x ,è¿”å›çš„ä»ç„¶æ˜¯Promiseå¯¹è±¡

Promise {<resolved>: x}



awaitåé¢æ˜¯ä¸€ä¸ªPromiseå¯¹è±¡

ç­‰å¾…Promiseçš„çŠ¶æ€å‘ç”Ÿæ”¹å˜(ä¸”éœ€è¦æ˜¯resolve) æ‰è¿›è¡Œåç»­æ“ä½œ awaitåé¢çš„å€¼ ä¼šè¢«èµ‹å€¼ç»™â€˜=â€™å·¦ä¾§çš„å˜é‡

awaitä¸èƒ½å•ç‹¬ä½¿ç”¨ï¼Œéœ€è¦åœ¨asyncå‡½æ•°ä¸­ä½¿ç”¨



awaitåçš„Promiseå¯¹è±¡å¦‚æœrejectäº† é‚£æ•´ä¸ªasyncå‡½æ•°ä¼šä¸­æ–­æ‰§è¡Œ

è‹¥å¯èƒ½å˜ä¸ºrejectï¼Œéœ€è¦å°†awaitæ‰€åœ¨è¯­å¥æ”¾åœ¨try catchè¯­å¥ä¸­



å›è°ƒå‡½æ•° (err,result)=>{}

æ¢awaitå†™çš„è¯ ç”¨try catchæ¥å¤„ç†

ä¾‹å­ï¼š

```javascript
async function f() {
    try {
     await Promise.reject('å‡ºé”™äº†');
     console.log('ä¸Šé¢å·²ç»å‡ºé”™äº†');
     return await Promise.resolve('hello world');
    } catch(e) {
        console.log(e);
    }
  }
```

æ‰“å°å‡ºâ€˜å‡ºé”™äº†â€™ åé¢ä»£ç ä¸å†æ‰§è¡Œï¼›å¦‚æœä¸é€‚ç”¨try catchè¯­å¥ ä¼šçˆ†çº¢é”™è¯¯

âŒ Uncaught (in promise) å‡ºé”™äº†



æ³¨æ„ğŸ’¡

let foo = await getFoo();

let bar = await getBar();

è¿™ç§å†™æ³•æ˜¯ä¼šé¡ºåºæ‰§è¡Œçš„ barä¼šç­‰fooæ‹¿åˆ°ä¹‹åå†æ‹¿ 

(å¦‚æœthenæ˜¯è¿™ç§å†™æ³• p1.thenxxx;p1.thenyyy;åˆ™æ˜¯å¹¶å‘æ‰§è¡Œ)



è¿™æ—¶å°±é Promise.alläº†

let [foo, bar] = await Promise.all([getFoo(), getBar()]);

è¿™ä¸ªæ—¶å€™fooå’Œbarå°±æ˜¯ä¼šå¹¶å‘æ‰§è¡Œäº† ä¸¤ä¸ªPromiseåŒ…æˆäº†ä¸€ä¸ª

ä½†æ˜¯ä¼šç­‰åˆ°ä¸¤ä¸ªç»“æœéƒ½æ‹¿åˆ°